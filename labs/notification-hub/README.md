Send Push Notifications to Mobile devices with Notification Hubs
=============
In this lab you will learn how to send push notification to a mobile device (Windows Phone or Android) directly from your Tessel. It demonstrates how to use Azure Notification Hub with the Notification Hubs REST API.


__This lab uses the tessel.io with the [ambient module](http://start.tessel.io/modules/ambient).__ This lab modifies the ambient sample, when a sound is registered it will send a push notification to all registered mobile devices.
You can choose between developing Android mobile app OR Windows Phone mobile app.

Prerequisites
-------------
In order to successfully complete this lab you need to:

* Required: Have successfully setup your Azure Subscription, your development environment and your Tessel according to instructions outlined in the [Setup Lab](../_setup).
* Required: Have a tessel ambient module configured according to this Tessel ambient module [description](http://start.tessel.io/modules/ambient)
* For the Android App:
	* Google Developer Account
	* Eclipse with Android SDK
* For Windows Phone App:
	* Visual Studio with Windows Phone SDK

Instructions
------------
In this lab you will:

* Create and configure a Notification Hub
* Create a mobile App to receive notifications
* Send notifications from your Tessel

_Please note in some cases receiving push notification is not possible with running emulators so you will need to run your mobile app on a real mobile device._

The source code for this lab contains two folders:
* Tessel - the node.js code to run on the Tessel device.
* VSProject - a Visual Studio solution with two projects:
  * GenerateSAS to generate the SAS Token in part 2
  * PhoneApp1 - a sample Windows Phone app registered to recieve push notifications

### Create an Azure Notification Hub and connect a mobile App
_You will create a new namespace and configure it for push notification providers like GCM (Google Cloud Messaging) and MPNS (Microsoft Push Notification Service). Also you will create a mobile app that will register to the service and receive the push notifications. You can choose to build an Android app, a Windws Phone app or both._

* For Android App follow instructions on: [Get started with Notification Hubs - Android](http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-android-get-started/)
* For Windows Phone App follow instructions on: [Get started with Notification Hubs - Windows Phone](http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-windows-phone-get-started/)


### Get the SAS Token
_Applications can authenticate to Microsoft Azure Service Bus (including Notification Hubs) using either Shared Access Signature (SAS) authentication, or by authenticating through Microsoft Azure Active Directory Access Control (also known as Access Control Service or ACS)._
In this lab we use SAS authentication. You will create a SAS Token that you will use later to authenticate from the Tessel device to Notification Hub. You paste the token string in your node.js code that will run on the Tessel for authentication.

The source code for this lab includes a C# Console application to generate the SAS Token.
* Open the project [../notification-hub/VSProject/GenerateSAS.sln](../notification-hub/VSProject/) in Visual Studio.
* Build and run the GenerateSAS project.

* Provide the following information:
  * Your Service bus namespace
  * Your Notification Hub name
  * The name of the shared access policy you want to use. You can use the automatically created DefaultFullSharedAccessSignature
  * The policy's shared access key. Copy this from the Azure portal; under Service Bus -> Notificatio Hubs -> your hub -> connection information. Select the SAS policy (DefaultFullSharedAccessSignature) and copy the SharedAccesKey from the connection string.
  * The expiration date for the SAS token. An empty value will set it to 10/31/2020 12:00

* Copy the complete output string, this is your SAS Token. Save this string, you will have to paste it later in your node.js

### Create the Node.js program to run on Tessel

* Edit the ambient_notificationhub_sas.js file from the lab folder [tessel\ambient_notificationhub_sas.js](../tessel/ambient_notificationhub_sas.js) in a text editor.

* Set the NotificationHub Parameters
 
  Edit the details in lines 13-15 under the NotificationHub parameters section. In line 13 enter your namespace, in line 14 enter your hub name. In line 15 paste the SAS Token you generated before
	
	```javascript
	// NotificationHub Parameters
	var NotificationHubNS = '<your ServiceBus namespace>.servicebus.windows.net'
	var hubName = '<Your hub name>'; 
	var Key = '<Your SAS Key generated by the SAS tool>';
	```

* Examine the sendNotification function
  The ambient_notificationhub_sas.js file contain two functions for sending notifications:
	* sendNotificationAndroid(message) - For sending push notifications to Android with GCM
	* sendNotificationWP(message) - For sending push notifications to Windows Phone with MPNS 

  The function gets a message and sends it as a push notification using the Notification Hub REST API. This is the code for the sendNotificationAndroid function: 

	```javascript
	function sendNotificationAndroid(message) {
	
	    var options = {
	        hostname: NotificationHubNS,
	        port: 443,
	        path: '/' + hubName + '/' + 'messages/' + '?api-version=2013-08',
	        method: 'POST',
	        headers: {
	            'Authorization': Key,
	            'Content-Type': 'application/xml;charset=utf-8',
	            'ServiceBusNotification-Format' : 'gcm', 
	        }
	    };
	
	    var req = https.request(options, function (res) {
	        console.log("sendNotificationAndroid:statusCode: ", res.statusCode);
	        console.log("sendNotificationAndroid:headers: ", res.headers);	
	
			res.setEncoding('utf8');
	        res.on('data', function (d) {
	            
	        });
	    });
	
	    req.on('error', function (e) {
	        console.error(e);
	    });
		
		var data = '{"data":{"message":"' + message + '"}}';
	    req.write(data);
	    req.end();
	}
    ```

* Set the platform(s) to receive notifications
  When a sound is registered by the sensor both sendNotificationAndroid and sendNotificationWP functions are called. In case you are interested in sending notifications only to Android or only to Windows Phone just comment the function you do not want to be called. See the code below:

	```javascript
	ambient.on('sound-trigger', function(data) {
		console.log("Something happened with sound: ", data);
		//sendNotificationWP("Something happened with sound");
		sendNotificationAndroid("Something happened with sound");
	}
	```

### Run ambient_notificationhub_sas.js on your Tessel

Make sure the tessel is connected to wifi by running: 

```
	tessel wifi -l
```

If tessel is not connected to wifi connect it using the command:

```
	tessel wifi -n "network name" -p "password"
```

Open node.js command prompt and navigate to the folder Tessel\ambient_notificationhub_sas.js. Run the ambient_notificationhub_sas.js

```
	tessel run ambient_notificationhub_sas.js
```

When the app is running clap or make some noise near the tessel device. You should get a push notification on your mobile device and the app should display the status code recived from calling the Notification Hub REST API.

 ```
	sendNotificationWP:headers:  {
	date : Fri, 07 Nov 2014 20:40:01 GMT,
	transfer-encoding : chunked,
	content-type : application/xml; charset=utf-8,
	server : Microsoft-HTTPAPI/2.0
	}
	sendNotificationAndroid:statusCode:  201
	sendNotificationAndroid:headers:  {
	date : Fri, 07 Nov 2014 20:40:03 GMT,
	transfer-encoding : chunked,
	content-type : application/xml; charset=utf-8,
	server : Microsoft-HTTPAPI/2.0
	}
```
	
Summary
-------
You have:

* Created an Notification Hub inside of Service Bus
* Sent push notification to a mobile device
* Used the GenerateSAS.exe tool to generate a SAS token (you can also use this for Service Bus Queues, Topics and Events Hub)
* Used the Tessel Ambient module
* Deployed a program to the Tessel device that sends push notifications using the Notification Hub REST API. 


__Go ahead and play with the solution. Tweak it, extend it, use it in a bigger context. Have fun!__

More Information
----------------
[Shared Access Signature Authentication with Service Bus](http://msdn.microsoft.com/en-us/library/azure/dn170477.aspx)
